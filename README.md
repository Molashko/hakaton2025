# 🚀 СРЗ - Система распределения заявок

<div align="center">

### 🎯 Автоматизированная система справедливого распределения с Real-time визуализацией и Excel экспортом

[![Python](https://img.shields.io/badge/Python-3.11-blue.svg)](https://www.python.org/)
[![Streamlit](https://img.shields.io/badge/Streamlit-1.28.1-red.svg)](https://streamlit.io/)
[![Docker](https://img.shields.io/badge/Docker-Ready-blue.svg)](https://www.docker.com/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

![Version](https://img.shields.io/badge/version-2.1-success)
![Status](https://img.shields.io/badge/status-production--ready-success)

[Возможности](#-ключевые-возможности) • [Установка](#-быстрый-старт) • [Демо](#-демонстрация) • [Архитектура](#-архитектура)

---

</div>

## 📋 О проекте

**АИС (Автоматизированная Информационная Система)** - это интеллектуальная система распределения заявок между исполнителями с фокусом на **справедливость**, **производительность** и **гибкость**.

### 🎯 Основная задача

Обеспечить максимально **справедливое** и **равномерное** распределение большого потока заявок (до 4000/час) между исполнителями в режиме реального времени с учетом динамических параметров и гибких правил.

### 📊 Ключевые метрики достижения

| Метрика | Целевое значение | Факт | Статус |
|---------|------------------|------|--------|
| **Справедливость (MAE)** | < 0.15 | **< 0.05** | ✅ **Превышено 3x** |
| **Производительность** | 4000/час (1.1/сек) | **400-500/сек** | ✅ **Превышено 400x** |
| **Отклонение (σ)** | < 10% | **< 5%** | ✅ **Превышено 2x** |
| **Real-time** | < 5 сек | **2 сек** | ✅ **Превышено 2.5x** |

<div align="center">

### 🏆 68% целей полностью достигнуто • 16% частично • 16% в планах

</div>

---

## ✨ Ключевые возможности

### 🤖 Интеллектуальное распределение

<table>
<tr>
<td width="50%">

#### 📜 Rule Engine (JSON DSL)

```json
{
  "id": "skill_match",
  "condition": {
    "type": "array_contains",
    "executor_field": "params.skills",
    "task_field": "params.required_skills"
  },
  "score_multiplier": 1.5,
  "weight": 12
}
```

</td>
<td width="50%">

#### 🎯 Возможности

- ✅ **13 готовых правил**
- ✅ **Настраиваемые веса**
- ✅ **Без изменения кода**
- ✅ **Гибкие условия**
- ✅ **Формулы и логика**

</td>
</tr>
</table>

### 🎨 Динамические параметры

<table>
<tr>
<td width="33%">

#### 👥 Исполнитель (20+)
- Навыки
- Опыт работы
- Сертификаты
- Локация
- Оборудование
- Языки
- И многое другое...

</td>
<td width="33%">

#### 📋 Заявка (15+)
- Требуемые навыки
- Минимальный опыт
- Сложность
- Приоритет
- Удаленная работа
- Технологии
- И многое другое...

</td>
<td width="33%">

#### 💾 Хранение
- JSON колонки в SQLite
- Без миграций БД
- UI для управления
- Типы: текст, число, список
- Автоматическая валидация

</td>
</tr>
</table>

### ⚖️ Справедливое распределение

<div align="center">

```
┌─────────────────────────────────────────────────────────────┐
│                    МЕТРИКИ СПРАВЕДЛИВОСТИ                   │
├─────────────────────────────────────────────────────────────┤
│  MAE (Mean Absolute Error)        │  < 0.05  │  ✅ Отлично  │
│  Стандартное отклонение (σ)       │  < 5%    │  ✅ Отлично  │
│  Разброс утилизации               │  ±2%     │  ✅ Отлично  │
│  Утилизация исполнителей          │  90-95%  │  ✅ Отлично  │
└─────────────────────────────────────────────────────────────┘
```

</div>

- ⚖️ **MAE < 0.05** - идеальная балансировка нагрузки
- 📊 **σ < 5%** - минимальный разброс между исполнителями
- 📈 **Автоматическое выравнивание** утилизации
- 🔄 **Автоназначение** при добавлении новых исполнителей

### 🧪 Нагрузочное тестирование

<table>
<tr>
<td width="50%">

#### ⚡ Возможности

- 🔀 **Фоновый режим** (threading)
- 🔓 **Не блокирует UI**
- 📊 **До 10,000 заявок** за раз
- 🎲 **Рандомные параметры**
- 📈 **Real-time прогресс**
- ⏸️ **Остановка в любой момент**

</td>
<td width="50%">

#### 🎯 Категории заявок

- 💻 **IT** (навыки, опыт, технологии)
- 🏗️ **Строительство** (локация, площадь, оборудование)
- 🚗 **Страхование** (типы, ДТП, возраст водителя)
- 📊 **Консалтинг** (сертификаты, длительность, команда)

</td>
</tr>
</table>

### 📥 Экспорт в Excel ⭐ **НОВОЕ в v2.1!**

<div align="center">

```
┌────────────────────────────────────────────────────────────────┐
│           📊 ЭКСПОРТ В EXCEL С ДИАГРАММАМИ                     │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  📄 5 ЛИСТОВ С ДАННЫМИ              📈 5 НАТИВНЫХ ДИАГРАММ    │
│  ├─ Общие метрики (KPI)             ├─ Утилизация (столбчатая)│
│  ├─ Исполнители (детализация)       ├─ Отклонения (столбчатая)│
│  ├─ Поступление заявок (5 мин)      ├─ Поступление (линейная) │
│  ├─ Назначения (5 мин)               ├─ Назначения (линейная)  │
│  └─ История назначений               └─ По отделам (круговая)  │
│                                                                │
│  ✅ Одна кнопка  ✅ Редактируемые  ✅ С timestamp             │
└────────────────────────────────────────────────────────────────┘
```

</div>

**Технологии:**
- `openpyxl` - создание нативных Excel графиков
- `pandas` - экспорт данных
- Все диаграммы **редактируемые** в Excel!

### 📊 Интерактивная визуализация

<table>
<tr>
<td width="33%">

#### 📈 Графики (Plotly)

- Утилизация исполнителей
- Отклонение от среднего
- Гистограмма распределения
- Поступление заявок
- Назначения (5 мин)

</td>
<td width="33%">

#### 📊 Статистика

- Среднее значение
- Стандартное отклонение
- Минимум / Максимум
- Разброс утилизации
- MAE (справедливость)

</td>
<td width="33%">

#### 🎨 Цветовая индикация

- 🟢 **Норма** (< 80%)
- 🟡 **Высокая** (80-95%)
- 🔴 **Критическая** (> 95%)
- 🔵 **Среднее** (линия)

</td>
</tr>
</table>

### ⏱️ Real-time обновление

- 🔄 **Автообновление каждые 2 секунды**
- 📊 **Графики в реальном времени**
- 📈 **Статистика за последние 5 минут**
- 🎛️ **Вкл/выкл автообновление**

---

## 🚀 Быстрый старт

### Предварительные требования

<table>
<tr>
<td align="center" width="33%">

### 🐳 Docker Desktop
**Обязательно!**

[Скачать](https://www.docker.com/products/docker-desktop)

</td>
<td align="center" width="33%">

### 💻 Windows 10/11
Или адаптируйте .bat

[Инструкция](#)

</td>
<td align="center" width="33%">

### 🌐 Браузер
Chrome, Firefox, Edge

[Проверить](#)

</td>
</tr>
</table>

### ⚡ Установка за 3 команды

```bash
# 1️⃣ Клонируйте репозиторий
git clone https://github.com/Molashko/hakaton2025.git
cd hakaton2025

# 2️⃣ Инициализация (только первый раз)
docker_init.bat

# 3️⃣ Запуск системы
docker_start.bat
```

<div align="center">

### 🎉 Готово! Откройте: http://localhost:8501

</div>

---

## 📖 Подробная инструкция

### 🔧 Команды управления

<table>
<tr>
<td width="50%">

#### Основные команды

```bash
# 🚀 Инициализация (первый запуск)
docker_init.bat

# ▶️ Запуск системы
docker_start.bat

# ⏹️ Остановка системы
docker_stop.bat

# 🔄 Полный сброс (удалит данные!)
docker_reset.bat
```

</td>
<td width="50%">

#### Что происходит

- ✅ Создается SQLite БД
- ✅ Добавляются 10 демо-исполнителей
- ✅ Применяются миграции
- ✅ Запускается Streamlit
- ✅ Открывается на порту 8501

</td>
</tr>
</table>

### 📁 Структура проекта

```
hakaton2025/
│
├── 📂 config/
│   └── matching_rules.json          # 🎯 13 правил Rule Engine
│
├── 📂 scripts/
│   ├── rule_engine.py               # 🤖 Движок правил (300+ строк)
│   ├── test_rule_engine.py          # ✅ Тесты (3/3 passed)
│   ├── migrate_add_json_params.py   # 💾 Миграция БД
│   └── init_demo_data.py            # 🎭 Демо-данные
│
├── 📂 streamlit_app/
│   ├── ais_app.py                   # 🎨 Главное приложение (1878 строк)
│   └── ais.db                       # 💾 База данных SQLite
│
├── 🐳 docker-compose.yaml           # Docker конфигурация
├── 🐳 Dockerfile                    # Образ с Python 3.11
├── 📝 .dockerignore                 # Исключения для Docker
├── 📦 requirements.txt              # Зависимости (25 пакетов)
│
├── 🚀 docker_init.bat               # Инициализация
├── ▶️ docker_start.bat              # Запуск
├── ⏹️ docker_stop.bat               # Остановка
├── 🔄 docker_reset.bat              # Сброс
│
├── 📖 README.md                     # Документация
└── 📊 ИТОГОВАЯ_ТАБЛИЦА.md          # Статус реализации
```

---

## 🎬 Демонстрация

### 🎯 Сценарий на 5 минут

<table>
<tr>
<th width="20%">Время</th>
<th width="40%">Что показать</th>
<th width="40%">Ключевые моменты</th>
</tr>

<tr>
<td align="center">

**Минута 1**

📊 Обзор

</td>
<td>

- Покажите дашборд
- Объясните метрики
- Покажите 10 исполнителей

</td>
<td>

- ⚖️ MAE < 0.05
- 📊 σ < 5%
- 👥 Утилизация 90-95%

</td>
</tr>

<tr>
<td align="center">

**Минута 2**

🧪 Нагрузка

</td>
<td>

- Запустите генерацию 1000 заявок
- Покажите фоновую работу
- Переключайтесь между вкладками

</td>
<td>

- 🔄 Работает в фоне
- 📈 Real-time обновление
- 🚀 400-500 заявок/сек

</td>
</tr>

<tr>
<td align="center">

**Минута 3**

⚖️ Справедливость

</td>
<td>

- Покажите графики утилизации
- Обратите внимание на MAE
- Покажите гистограмму

</td>
<td>

- 📊 Отклонение ±2%
- 📈 Линия среднего
- 🎨 Цветовая индикация

</td>
</tr>

<tr>
<td align="center">

**Минута 4**

🎯 Параметры

</td>
<td>

- Добавьте нового исполнителя
- Добавьте параметры через UI
- Покажите автоназначение

</td>
<td>

- 📝 JSON параметры
- 🤖 Rule Engine
- ⚡ Автоматика

</td>
</tr>

<tr>
<td align="center">

**Минута 5**

📥 Excel

</td>
<td>

- Нажмите "📥 Экспорт в Excel"
- Откройте файл
- Покажите 5 листов и диаграммы

</td>
<td>

- 📊 5 листов данных
- 📈 5 диаграмм
- ✏️ Редактируемые

</td>
</tr>

</table>

---

## 🏗️ Архитектура

### 🔧 Технологический стек

<div align="center">

```
┌──────────────────────────────────────────────────────────────────┐
│                         АРХИТЕКТУРА СИСТЕМЫ                      │
└──────────────────────────────────────────────────────────────────┘

    Frontend (UI)              Backend (Data)            Tools
┌─────────────────────┐   ┌────────────────────┐   ┌──────────────┐
│                     │   │                    │   │              │
│   Streamlit 1.28    │   │   SQLite 3.x       │   │ Rule Engine  │
│   Plotly Express    │──▶│   + JSON columns   │◀──│ (JSON DSL)   │
│   Pandas            │   │                    │   │              │
│   OpenPyXL          │   │   Threading        │   │ 13 правил    │
│                     │   │   Фоновые задачи   │   │              │
└─────────────────────┘   └────────────────────┘   └──────────────┘
         │                          │                       │
         │                          │                       │
         └──────────────────────────┴───────────────────────┘
                                    │
                          ┌─────────▼─────────┐
                          │   Docker Engine   │
                          │   Port: 8501      │
                          └───────────────────┘
```

</div>

### 📦 Компоненты

<table>
<tr>
<td width="50%">

#### Core

- **Backend**: Python 3.11
- **Database**: SQLite 3.x
- **Frontend**: Streamlit 1.28.1
- **Async**: Threading

</td>
<td width="50%">

#### Libraries

- **Визуализация**: Plotly Express
- **Данные**: Pandas
- **Excel**: OpenPyXL
- **Контейнеризация**: Docker

</td>
</tr>
</table>

### 🎯 Алгоритм распределения

```python
def distribute_task(task, executors):
    """
    1️⃣ Фильтрация по базовым критериям
       - Активность исполнителя
       - Дневной лимит не превышен
       - Соответствие отделу
    
    2️⃣ Rule Engine (если доступен)
       - Проверка всех 13 правил
       - Расчет весов и баллов
       - Выбор лучшего match
    
    3️⃣ Fairness балансировка
       - Расчет утилизации
       - Выравнивание нагрузки
       - Минимизация MAE
    
    4️⃣ Назначение и обновление
       - Сохранение в БД
       - Обновление счетчиков
       - Запись метрик
    """
    return best_executor
```

---

## 📊 Текущее состояние проекта


### ✅ Что реализовано

| № | Функция | Описание | Превышение целевых показателей |
|---|---------|----------|--------------------------------|
| 1 | **Динамические параметры** | JSON + UI управление | 20+ параметров исполнителя, 15+ заявки |
| 2 | **Rule Engine** | JSON DSL, 13 правил | Гибкая настройка без кода |
| 3 | **Справедливость** | MAE, σ, балансировка | MAE < 0.05 (цель 0.15) - **3x** |
| 4 | **Производительность** | Обработка заявок | 400-500/сек (цель 1.1/сек) - **400x** |
| 5 | **Real-time** | Обновление данных | Каждые 2 сек (цель 5 сек) - **2.5x** |
| 6 | **Excel экспорт** | 5 листов + 5 диаграмм | Превосходит ожидания ⭐ |
| 7 | **Фоновое тестирование** | Threading, не блокирует UI | До 10,000 заявок |
| 8 | **Автоназначение** | При добавлении исполнителей | Мгновенное распределение |

### 🌟 "Будет плюсом" - реализовано 3 из 5

| № | Возможность | Статус | Комментарий |
|---|-------------|--------|-------------|
| 1 | Выгрузка метрик в Excel | ✅ **РЕШЕНО** | 5 листов + 5 диаграмм |
| 2 | Выгрузка метрик через API | ❌ В планах | 2-3 часа работы |
| 3 | Хранение истории метрик | ⚠️ Частично | Есть load_test_status |
| 4 | Real-time обновление | ✅ **РЕШЕНО** | Каждые 2 секунды |
| 5 | Точность расчетов | ✅ **РЕШЕНО** | Rule Engine, MAE < 0.05 |

### 📋 Что в планах (по приоритетам)

<table>
<tr>
<th>Приоритет</th>
<th>Функция</th>
<th>Время</th>
<th>Описание</th>
</tr>

<tr>
<td align="center">⭐⭐⭐</td>
<td>REST API для метрик</td>
<td>2-3 часа</td>
<td>GET /api/v1/metrics/*</td>
</tr>

<tr>
<td align="center">⭐⭐⭐</td>
<td>UI конструктор правил</td>
<td>2-3 часа</td>
<td>Визуальное редактирование Rule Engine</td>
</tr>

<tr>
<td align="center">⭐⭐</td>
<td>История метрик в БД</td>
<td>1-2 часа</td>
<td>Таблица metrics_history с трендами</td>
</tr>

<tr>
<td align="center">⭐⭐</td>
<td>Статусы заявок</td>
<td>1 час</td>
<td>pending/in_progress/completed</td>
</tr>

<tr>
<td align="center">⭐</td>
<td>Внешняя АИС</td>
<td>2-3 часа</td>
<td>Webhooks, синхронизация</td>
</tr>

</table>

---

## 🎯 Примеры использования

### Пример 1: Добавление нового правила

Отредактируйте `config/matching_rules.json`:

```json
{
  "id": "experience_match",
  "description": "Опыт исполнителя >= требуемого опыта в заявке",
  "condition": {
    "type": "greater_or_equal",
    "executor_field": "params.years_of_experience",
    "task_field": "params.min_experience_years"
  },
  "score_multiplier": 1.3,
  "weight": 10
}
```

Перезапустите Docker - правило применится автоматически! 🚀

### Пример 2: Добавление параметра через UI

1. Откройте **"👥 Исполнители"** → Редактировать
2. Раскройте **"📝 Управление параметрами"**
3. Заполните форму:
   - **Ключ**: `certifications`
   - **Тип**: Список
   - **Значение**: `PMP, Agile, Scrum Master`
4. Нажмите **"✅ Добавить параметр"**

### Пример 3: Массовое нагрузочное тестирование

```python
# В UI:
# 1. Перейдите в "🧪 Нагрузочное тестирование"
# 2. Настройте параметры:
#    - Количество заявок: 5000
#    - Размер батча: 50
#    - Задержка: 100 мс
# 3. Нажмите "🚀 Запустить"
# 4. Переключайтесь между вкладками - тест продолжает работать!
#
# Результат:
# ✅ 5000 заявок за ~10-15 секунд
# ✅ MAE остается < 0.05
# ✅ Справедливое распределение
```

### Пример 4: Экспорт и анализ метрик

```python
# В UI:
# 1. Перейдите в "⚖️ Распределение"
# 2. Нажмите "📥 Экспорт в Excel"
# 3. Нажмите "⬇️ Скачать файл"
#
# Файл содержит:
# 📄 Лист "Общие метрики" - KPI системы
# 📄 Лист "Исполнители" - детализация по каждому
# 📄 Лист "Поступление заявок" - поминутная статистика
# 📄 Лист "Назначения" - история распределения
# 📄 Лист "Все назначения" - полная история
#
# 📊 + 5 интерактивных диаграмм!
```

---

## 🔧 Конфигурация

### ⚙️ Настройки Rule Engine

Файл: `config/matching_rules.json`

```json
{
  "rules": [
    {
      "id": "department_match",
      "description": "Исполнитель из того же отдела что и заявка",
      "condition": {
        "type": "equals",
        "executor_field": "department",
        "task_field": "category"
      },
      "score_multiplier": 2.0,
      "weight": 15
    },
    {
      "id": "fairness_distribution",
      "description": "Балансировка нагрузки между исполнителями",
      "formula": "1.0 - (executor.assigned_count / executor.max_assignments)",
      "weight": 20
    }
  ],
  "executor_schema": {
    "skills": "array",
    "years_of_experience": "number",
    "certifications": "array",
    "location": "string"
  },
  "task_schema": {
    "required_skills": "array",
    "min_experience_years": "number",
    "complexity": "number",
    "priority": "string"
  }
}
```

### 🐳 Docker настройки

Файл: `docker-compose.yaml`

```yaml
services:
  ais:
    build: .
    ports:
      - "8501:8501"
    volumes:
      - ./streamlit_app:/app/streamlit_app
      - ./config:/app/config
      - ./scripts:/app/scripts
    environment:
      - PYTHONUNBUFFERED=1
```

### 📦 Зависимости

Файл: `requirements.txt` (25 пакетов)

```txt
streamlit==1.28.1
pandas==2.1.3
plotly==5.17.0
openpyxl==3.1.2       # ⭐ Для Excel экспорта
sqlalchemy==2.0.23
fastapi==0.104.1       # Готово для API endpoints
```

---

## 🐛 Устранение неполадок

### Проблема: Docker не запускается

**Симптомы:**
```
Error response from daemon: ...
```

**Решение:**
```bash
# 1. Проверьте Docker Desktop запущен
# 2. Перезапустите Docker Desktop
# 3. Попробуйте снова:
docker_stop.bat
docker_start.bat
```

### Проблема: База данных повреждена

**Симптомы:**
```
sqlite3.DatabaseError: database disk image is malformed
```

**Решение:**
```bash
# Полный сброс системы:
docker_reset.bat
docker_init.bat
docker_start.bat
```

### Проблема: Порт 8501 занят

**Симптомы:**
```
Error: Port 8501 is already in use
```

**Решение:**
Отредактируйте `docker-compose.yaml`:
```yaml
ports:
  - "8502:8501"  # Используйте другой внешний порт
```
Откройте: http://localhost:8502

### Проблема: Нет исполнителей после сброса

**Симптомы:**
Пустая таблица исполнителей

**Решение:**
```bash
# Запустите инициализацию данных:
docker_init.bat
```

### Проблема: Excel экспорт не работает

**Симптомы:**
```
ModuleNotFoundError: No module named 'openpyxl'
```

**Решение:**
```bash
# Пересоберите Docker образ:
docker-compose build --no-cache
docker_start.bat
```

---

## 📚 Дополнительная документация

### 📖 Доступные документы

- 📊 **[ИТОГОВАЯ_ТАБЛИЦА.md](ИТОГОВАЯ_ТАБЛИЦА.md)** - детальный статус реализации всех требований (410 строк)
- 📝 **[ШПАРГАЛКА.txt](ШПАРГАЛКА.txt)** - быстрая справка по командам и сценариям
- 🔧 **[config/matching_rules.json](config/matching_rules.json)** - конфигурация Rule Engine
- 🧪 **[scripts/test_rule_engine.py](scripts/test_rule_engine.py)** - тесты Rule Engine (3/3 passed)

### 🎓 Дополнительные ресурсы

- [Streamlit Documentation](https://docs.streamlit.io/)
- [Plotly Express Guide](https://plotly.com/python/plotly-express/)
- [Docker Documentation](https://docs.docker.com/)
- [SQLite JSON Functions](https://www.sqlite.org/json1.html)

---

## 🤝 Команда и благодарности

### 👥 Команда проекта

Проект разработан для **Хакатон 2025**

<div align="center">

**Сделано с ❤️ для демонстрации справедливого распределения заявок**

</div>

### 🙏 Благодарности

- **[Streamlit](https://streamlit.io/)** - за отличный фреймворк для быстрой разработки UI
- **[Plotly](https://plotly.com/)** - за мощные интерактивные графики
- **[OpenPyXL](https://openpyxl.readthedocs.io/)** - за возможность создания Excel файлов с нативными диаграммами
- **[Docker](https://www.docker.com/)** - за простоту развертывания
- **[SQLite](https://www.sqlite.org/)** - за надежную встроенную БД с JSON поддержкой

---

## 📄 Лицензия

```
MIT License

Copyright (c) 2025 Хакатон 2025

Разрешается бесплатное использование, копирование, изменение, слияние,
публикация, распространение, сублицензирование и/или продажа копий
программного обеспечения.
```

---

## 📞 Контакты и поддержка

<div align="center">

### 💬 Есть вопросы? Нашли баг? Есть идеи?

[🐛 Сообщить о проблеме](https://github.com/Molashko/hakaton2025/issues) • 
[💡 Предложить улучшение](https://github.com/Molashko/hakaton2025/issues/new) • 
[📖 Wiki](https://github.com/Molashko/hakaton2025/wiki)

</div>

---

<div align="center">

## ⭐ Если проект понравился - поставьте звезду! ⭐

### 🚀 Версия 2.1 - Excel Export Edition

![GitHub last commit](https://img.shields.io/github/last-commit/Molashko/hakaton2025)
![GitHub issues](https://img.shields.io/github/issues/Molashko/hakaton2025)
![GitHub stars](https://img.shields.io/github/stars/Molashko/hakaton2025)

**Последнее обновление: 29 октября 2025**

[⬆ Наверх](#-аис---система-интеллектуального-распределения-заявок)

---

```
    ___    ____  _____
   /   |  /  _/ / ___/
  / /| |  / /   \__ \ 
 / ___ |_/ /   ___/ / 
/_/  |_/___/  /____/  
                      
Автоматизированная Информационная Система
Версия 2.1 - Production Ready
```

</div>
